// EasyOPOA Framework
//
// Version 2.0.0
//
// Copy By RAY
// inthinkcolor@gmail.com
// 2013
//
// https://github.com/ushelp/EasyOPOA
//
!function(a){var M,b=a.EasyOPOA,c=a.OPOA,d={eles:{},home:{}},e=!0,f=a.location.href.split("#")[0]+"#",g=function(a,b,c,e){var f,g;"post"==c.method.toLowerCase()&&(f=b.indexOf("?"),-1!=f&&(e=(e?e:"")+"&"+b.substring(f+1),b=b.substring(0,f))),g=x[a]||M.Configs.loading,g.start&&g.start(a,b,c,e),$.ajax({url:b,type:c.method,data:e,success:function(f){var j,k,h=c.show,i=d.eles[h];i||(i=$(h),d.eles[h]=i),j=f,c.find&&(j=$("<div>").html(f).find(c.find).html(),j||("function"==typeof w[a]?(w[a](),j=""):(k=w[a].toLowerCase(),j="empty"==k?"":"all"==k?f:w[a]))),g.success&&g.success(a,b,c,e),i.html(j)},statusCode:z[a]||M.Configs.urlErrors,error:function(){g.error&&g.error(a,b,c,e)},complete:function(){g.end&&g.end(a,b,c,e)}})},h=function(a){var b=a.data,c=$(this).attr(b.hash),d=$(this).attr(b.url);c||$(this).attr("href")&&(c=$(this).attr("href")),d||$(this).attr("href")&&(d=$(this).attr("href")),c&&(A[c]&&(d=A[c][0]),m(c,d,b),g(c,d,b,null),b.prevent&&a.preventDefault())},i=function(a){$(a.actions).off("click",h),$(a.actions).on("click",a,h)},j=function(a,b,c){var e,f,g,h,i,d=b.exec(c);if(d){for(e=B[a][0],f=d.slice(1),$.each(f,function(a,b){f[a]=decodeURIComponent(b)}),g=new Array,a.replace(G,function(a){g.push(a.substring(1))}),h={},i=0;i<f.length;i++)h[g[i]]=f[i];return e=e.replace(I,function(a,b){return h[b]?h[b]:(b=b.replace(J,""),K.test(b)?f[parseInt(b)]:"")})}return c},k=function(){B&&$.each(B,function(a,b){var f,c=L(a),d=b[1],e={};$.extend(!0,e,M.Configs,d),f=n(e),$(e.actions).each(function(){var g,h;b[0],g=$(this).attr(e.hash),c.test(g)&&(z[g]=f.urlError,x[g]=f.loading,h=A[g][0],A[g][0]=j(a,c,h),A[g][1]=e)})})},l=function(b,c,d){var e,g;a.history.pushState&&(e=f+b,g={hash:b,url:c,opoa:d},a.history.replaceState(g,document.title,e))},m=function(b,c,d){var e,g;a.history.pushState?(e=f+b,g={hash:b,url:c,opoa:d},a.history.pushState(g,document.title,e)):a.location.hash="#"+b,M.cookieLast&&$.cookie&&a.JSON&&JSON.parse&&($.cookie("hash",b),$.cookie("url",c),$.cookie("opoa",JSON.stringify(d)))},n=function(a){var c,b=a.urlErrors;return delete a.urlErrors,c=a.loading,delete a.loading,{urlErrors:b,loading:c}},o=function(a){$.each(B,function(b,c){var f,g,h,d=L(b),e=c[1];return d.test(a)?(f={},$.extend(!0,f,M.Configs,e),g=j(b,d,a),w[a]=f.notFound,h=n(f),z[a]=h.urlError,x[a]=h.loading,A[a]=[g,f],!1):void 0})},p=function(a){var b={};return $(a.actions).each(function(){var d=$(this).attr(a.hash),e=$(this).attr(a.url);e?b[d]=[e,a]:(o(d),b[d]||(e=d,b[d]=[e,a]))}),b},q=function(a,b){var c={};return $(a.actions).each(function(){var e=$(this).attr(a.hash);c[e]=b}),c},r=function(a,b){var c={};return $(a.actions).each(function(){var e=$(this).attr(a.hash);c[e]=b}),c},s=function(a){$(a.actions).each(function(){var c=$(this).attr(a.hash);w[c]=a.notFound}),delete a.notFound},t=function(a,b){var c,d;o(a),A[a]?(c=A[a][0],d={},8!=y(A[a][1])?($.extend(!0,d,M.Configs,A[a][1]),n(d),A[a][1]=d):d=A[a][1],l(a,c,d),g(a,c,d,b)):M.notHash(a)},u=function(){var a,b;d.home.hash?d.home.url?g(d.home.hash,d.home.url,d.home.opoa,d.home.postData):(a=d.home.hash,b=d.home.postData,t(a,b)):M.homeFun()},v=function(a){delete a.notFound,delete a.loading,delete a.urlErrors},w={},x={},y=function(a){var b=0;return $.each(a,function(){b++}),b},z={},A={},B={},C=Array.isArray||function(a){return"[object Array]"==Object.prototype.toString.call(a)},D=/\((.*?)\)/g,E=/(\(\?)?:\w+/g,F=/\*\w+/g,G=/(\(\?)?:\w+|\*\w+/g,H=/[\-{}\[\]+?.,\\\^$|#\s]/g,I=/\{([^}]+)\}/g,J=/\ /g,K=/^[0-9]+$/,L=function(a){return a=a.replace(H,"\\$&").replace(D,"(?:$1)?").replace(E,function(a,b){return b?a:"([^/]+)"}).replace(F,"(.*?)"),new RegExp("^"+a+"$")};$(a).on("popstate",function(){var b,c,d;a.history.state?(b=a.history.state.url,c=a.history.state.hash,d=a.history.state.opoa,g(c,b,d,null)):u()}),M={cookieLast:!0,Configs:{actions:null,show:null,hash:"hash",url:"hash",find:null,notFound:"empty",method:"post",prevent:!0,actionMaps:{},urlErrors:{404:function(){},500:function(){}},loading:{start:function(){},success:function(){},error:function(){},end:function(){}}},notHash:function(){},addActionMap:function(a,b,c){if(C(a))$.each(a,function(a,b){if(C(b)){var c={};$.extend(!0,c,M.Configs,b[2]),w[b[0]]=c.notFound,v(c),-1!=b[0].indexOf(":")||-1!=b[0].indexOf("*")?B[b[0]]=[b[1],c]:A[b[0]]=[b[1],c]}else $.each(b,function(a,b){var c={};c=$.extend(!0,c,M.Configs,b[1]),w[a]=c.notFound,v(c),-1!=a.indexOf(":")||-1!=a.indexOf("*")?B[a]=[b[0],c]:A[a]=[b[0],c]})});else{var d={};$.extend(!0,d,M.Configs,c),w[a]=d.notFound,v(d),-1!=a.indexOf(":")||-1!=a.indexOf("*")?B[a]=[b,d]:A[a]=[b,d]}},addActionUrlErrors:function(a,b){C(a)?$.each(a,function(a,c){z[c]=b}):z[a]=b},addActionLoadings:function(a,b){C(a)?$.each(a,function(a,c){x[c]=b}):x[a]=b},start:function(b,c){c&&(C(c)?M.addActionMap(c):$.each(c,function(a,b){M.addActionMap(a,b[0],b[1])})),$(function(){var c,d,f;b&&($.each(b,function(a,b){var d,e,f,g,c={};$.extend(!0,c,M.Configs,b),d=n(c),b.actionMaps&&$.each(b.actionMaps,function(a,b){M.addActionMap(a,b,c)}),s(c),e=p(c),A=$.extend(e,A),f=q(c,d.urlErrors),z=$.extend(f,z),g=r(c,d.loading),x=$.extend(!0,g,x),i(c)}),k()),e&&(e=!1,a.location.hash?(c=a.location.hash.substring(1),t(c,null)):M.cookieLast?$.cookie&&a.JSON&&JSON.parse?(c=$.cookie("hash"),d=$.cookie("url"),f=$.cookie("opoa"),f?(f=JSON.parse(f),d&&(l(c,d,f),g(c,d,f,null))):u()):u():u())})},home:function(a,b){d.home={hash:a,postData:b}},homeUrl:function(a,b,c){var g,e="",f={};$.extend(!0,f,M.Configs,b),w[e]=f.notFound,delete f.notFound,g=n(f),M.addActionLoadings(e,g.loading),d.home={hash:e,url:a,opoa:f,postData:c}},homeFun:function(){},load:function(a,b){$(function(){o(a),A[a]?(m(a,A[a][0],A[a][1]),g(a,A[a][0],A[a][1],b)):notHash&&M.notHash(a)})},noConflict:function(d){return a.OPOA===M&&(a.OPOA=c),d&&a.EasyOPOA===M&&(a.EasyOPOA=b),M}},a.EasyOPOA=a.OPOA=M}(window);